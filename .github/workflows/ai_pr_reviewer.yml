name: ðŸ¤– AI Code Reviewer

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get PR Diff
        id: get_diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git fetch origin ${{ github.event.pull_request.head.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} > diff.txt
          echo "diff_path=diff.txt" >> "$GITHUB_OUTPUT"

      - name: Read Diff to Variable
        id: read_diff
        run: |
          DIFF_CONTENT=$(head -c 15000 diff.txt)
          DIFF_JSON=$(jq -Rs '.' <<< "$DIFF_CONTENT")
          echo "diff_json=$DIFF_JSON" >> "$GITHUB_OUTPUT"

      - name: Call Gemini API
        id: call_gemini
        run: |
          DIFF_JSON="${{ steps.read_diff.outputs.diff_json }}"

          BODY=$(jq -n --arg diff "$DIFF_JSON" '{
            contents: [{
              parts: [{
                text: "ë‹¹ì‹ ì€ ì „ë¬¸ ì½”ë“œ ë¦¬ë·°ì–´ìž…ë‹ˆë‹¤. ë‹¤ìŒ git diff ë‚´ìš©ì„ ë¶„ì„í•´ì„œ í•œêµ­ì–´ë¡œ ë‚´ìš©ì„ ìš”ì•½í•´ì£¼ì„¸ìš”. ì–´ë–¤ ì½”ë“œê°€ ì¶”ê°€/ë³€ê²½ë˜ì—ˆê³ , ì£¼ìš” ë³€ê²½ ëª©ì ì´ ë¬´ì—‡ì¸ì§€ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì œëª©ì€ 'ðŸ¤– AI ì½”ë“œ ë¦¬ë·° ìš”ì•½'ìœ¼ë¡œ ì‹œìž‘í•˜ê³ , ë§ˆì§€ë§‰ ì¤„ì—ëŠ” ë°˜ë“œì‹œ 'ðŸ“„ Note: ì´ ìš”ì•½ì€ Google Gemini 1.5 Flash ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' ë¼ëŠ” ë¬¸êµ¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.\n\n```diff\n\($diff)\n```"
              }]
            }]
          }')

          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          echo "response=$RESPONSE" >> "$GITHUB_OUTPUT"

      - name: Extract Gemini Response
        id: parse_gemini
        run: |
          echo "${{ steps.call_gemini.outputs.response }}" | jq -r '.candidates[0].content.parts[0].text // "â— Gemini ì‘ë‹µì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."' > summary.txt
          echo summary<<EOF >> $GITHUB_OUTPUT
          cat summary.txt >> $GITHUB_OUTPUT
          echo EOF >> $GITHUB_OUTPUT

      - name: Post AI Review as Comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${{ steps.parse_gemini.outputs.summary }}`
            })
#dssd