name: ğŸ¤– AI Code Reviewer

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get PR Diff
        id: get_diff
        # git ëª…ë ¹ì–´ëŠ” ì´ì²˜ëŸ¼ run: ì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git fetch origin ${{ github.event.pull_request.head.ref }}
          diff_output=$(git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }})
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$diff_output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Call Gemini API for Code Summary
        id: call_gemini
        run: |
          response=$(curl -s -H 'Content-Type: application/json' \
            -d '{
                  "contents": [{
                    "parts": [{
                      "text": "ë‹¹ì‹ ì€ ì „ë¬¸ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. ë‹¤ìŒ git diff ë‚´ìš©ì„ ë¶„ì„í•´ì„œ í•œêµ­ì–´ë¡œ ë‚´ìš©ì„ ìš”ì•½í•´ì£¼ì„¸ìš”. ì–´ë–¤ ì½”ë“œê°€ ì¶”ê°€/ë³€ê²½ë˜ì—ˆê³ , ì£¼ìš” ë³€ê²½ ëª©ì ì´ ë¬´ì—‡ì¸ì§€ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì œëª©ì€ ''ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ìš”ì•½''ìœ¼ë¡œ ì‹œì‘í•˜ê³ , ë‹µë³€ ë§ˆì§€ë§‰ ì¤„ì—ëŠ” ë°˜ë“œì‹œ ''ğŸ“„ Note: ì´ ìš”ì•½ì€ Google Gemini 1.5 Flash ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'' ë¼ëŠ” ë¬¸êµ¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.\n\n```diff\n${{ steps.get_diff.outputs.diff }}\n```"
                    }]
                  }]
                }' \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}")
          
          summary=$(echo "$response" | jq -r '.candidates[0].content.parts[0].text')

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Post Comment to PR
        uses: actions/github-script@v7
        with:
          # ì´ script: ë¸”ë¡ ì•ˆì—ëŠ” ì˜¤ì§ JavaScriptë§Œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${{ steps.call_gemini.outputs.summary }}`
            });