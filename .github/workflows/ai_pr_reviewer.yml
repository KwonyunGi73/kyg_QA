name: ðŸ¤– AI Code Reviewer

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get PR Diff
        id: get_diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git fetch origin ${{ github.event.pull_request.head.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} > diff.txt
          echo "diff_path=diff.txt" >> "$GITHUB_OUTPUT"

      - name: Read Diff to Variable
        id: read_diff
        run: |
          DIFF_CONTENT=$(head -c 15000 diff.txt)
          DIFF_JSON=$(jq -Rs '.' <<< "$DIFF_CONTENT")
          echo "diff_json=$DIFF_JSON" >> "$GITHUB_OUTPUT"

      - name: Call OpenAI API
        id: call_openai
        run: |
          DIFF_JSON=${{ steps.read_diff.outputs.diff_json }}

          REQUEST_DATA=$(jq -n --arg diff "$DIFF_JSON" '{
            model: "gpt-4o",
            messages: [
              {
                role: "system",
                content: "ë‹¹ì‹ ì€ ì „ë¬¸ ì½”ë“œ ë¦¬ë·°ì–´ìž…ë‹ˆë‹¤. git diff ë‚´ìš©ì„ ë³´ê³  ë³€ê²½ì‚¬í•­ì„ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”. ì–´ë–¤ ì½”ë“œê°€ ë³€ê²½/ì¶”ê°€ë˜ì—ˆëŠ”ì§€ ìš”ì•½í•˜ê³ , ë³€ê²½ ëª©ì ë„ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì œëª©ì€ 'ðŸ¤– AI ì½”ë“œ ë¦¬ë·° ìš”ì•½'ìœ¼ë¡œ ì‹œìž‘í•˜ê³ , ë§ˆì§€ë§‰ ì¤„ì—ëŠ” 'ðŸ“„ Note: ì´ ìš”ì•½ì€ OpenAI GPT-4o ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'ë¼ê³  ìž‘ì„±í•´ì£¼ì„¸ìš”."
              },
              {
                role: "user",
                content: "```diff\n\($diff)\n```"
              }
            ]
          }')

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d "$REQUEST_DATA")

          echo "response=$RESPONSE" >> "$GITHUB_OUTPUT"

      - name: Extract OpenAI Response
        id: parse_response
        run: |
          echo "${{ steps.call_openai.outputs.response }}" | jq -r '.choices[0].message.content // "â— OpenAI ì‘ë‹µ ì‹¤íŒ¨"' > summary.txt
          echo summary<<EOF >> $GITHUB_OUTPUT
          cat summary.txt >> $GITHUB_OUTPUT
          echo EOF >> $GITHUB_OUTPUT

      - name: Post AI Review as Comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${{ steps.parse_response.outputs.summary }}`
            })
